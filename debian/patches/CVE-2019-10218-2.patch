From bfa8a5991b15f69168587b88dc2d81c172f7617c Mon Sep 17 00:00:00 2001
From: Jeremy Allison <jra@samba.org>
Date: Tue, 6 Aug 2019 12:08:09 -0700
Subject: [PATCH 2/2] CVE-2019-10218 - s3: libsmb: Protect SMB2 client code
 from evil server returned names.

Disconnect with NT_STATUS_INVALID_NETWORK_RESPONSE if so.

BUG: https://bugzilla.samba.org/show_bug.cgi?id=14071

Signed-off-by: Jeremy Allison <jra@samba.org>
---
 source3/libsmb/cli_smb2_fnum.c | 7 +++++++
 1 file changed, 7 insertions(+)

Index: samba-4.3.11+dfsg/source3/libsmb/cli_smb2_fnum.c
===================================================================
--- samba-4.3.11+dfsg.orig/source3/libsmb/cli_smb2_fnum.c	2019-10-18 08:48:40.395634702 -0400
+++ samba-4.3.11+dfsg/source3/libsmb/cli_smb2_fnum.c	2019-10-18 08:48:40.391634686 -0400
@@ -768,6 +768,13 @@ NTSTATUS cli_smb2_list(struct cli_state
 				goto fail;
 			}
 
+			/* Protect against server attack. */
+			status = is_bad_finfo_name(cli, finfo);
+			if (!NT_STATUS_IS_OK(status)) {
+				smbXcli_conn_disconnect(cli->conn, status);
+				goto fail;
+			}
+
 			if (dir_check_ftype((uint32_t)finfo->mode,
 					(uint32_t)attribute)) {
 				/*
