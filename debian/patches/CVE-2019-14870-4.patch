From 67b2e7286c80d19b98fc5880ab6b39fa117af630 Mon Sep 17 00:00:00 2001
From: Isaac Boukris <iboukris@gmail.com>
Date: Thu, 21 Nov 2019 11:12:48 +0100
Subject: [PATCH 4/4] CVE-2019-14870: mit-kdc: enforce delegation_not_allowed
 flag

Signed-off-by: Isaac Boukris <iboukris@samba.org>
---
 source4/kdc/mit_samba.c  |  5 +++++
 source4/kdc/sdb_to_kdb.c | 17 ++++++-----------
 2 files changed, 11 insertions(+), 11 deletions(-)

--- a/source4/kdc/mit_samba.c
+++ b/source4/kdc/mit_samba.c
@@ -286,6 +286,11 @@ static int mit_samba_update_pac_data(str
 
 	ret = 0;
 
+	if ((kflags & KRB5_KDB_FLAG_CLIENT_REFERRALS_ONLY) == 0) {
+		kentry->attributes &= ~KRB5_KDB_DISALLOW_FORWARDABLE;
+		kentry->attributes &= ~KRB5_KDB_DISALLOW_PROXIABLE;
+	}
+
 done:
 	if (pac) krb5_pac_free(ctx->context, pac);
 	talloc_free(tmp_ctx);
