Backport of:

From 805850d4b67eff263a8dab0999ab59e6243534f1 Mon Sep 17 00:00:00 2001
From: Aaron Haslett <aaronhaslett@catalyst.net.nz>
Date: Tue, 23 Oct 2018 17:25:51 +1300
Subject: [PATCH 5/5] CVE-2018-14629 dns: CNAME loop prevention using counter

Count number of answers generated by internal DNS query routine and stop at
20 to match Microsoft's loop prevention mechanism.

BUG: https://bugzilla.samba.org/show_bug.cgi?id=13600

Signed-off-by: Aaron Haslett <aaronhaslett@catalyst.net.nz>
Reviewed-by: Andrew Bartlett <abartlet@samba.org>
Reviewed-by: Garming Sam <garming@catalyst.net.nz>
---
 python/samba/tests/dns.py      | 24 ++++++++++++++++++++++++
 selftest/knownfail.d/dns       |  6 ++++++
 source4/dns_server/dns_query.c |  6 ++++++
 3 files changed, 36 insertions(+)

Index: samba-4.3.11+dfsg/source4/dns_server/dns_query.c
===================================================================
--- samba-4.3.11+dfsg.orig/source4/dns_server/dns_query.c	2018-11-16 08:20:27.750193296 -0500
+++ samba-4.3.11+dfsg/source4/dns_server/dns_query.c	2018-11-16 08:40:18.952454663 -0500
@@ -39,6 +39,7 @@
 
 #undef DBGC_CLASS
 #define DBGC_CLASS DBGC_DNS
+#define MAX_Q_RECURSION_DEPTH 20
 
 static WERROR create_response_rr(const struct dns_name_question *question,
 				 const struct dnsp_DnssrvRpcRecord *rec,
@@ -261,6 +262,10 @@ static WERROR handle_question(struct dns
 	uint16_t rec_count, ai = *ancount;
 	struct ldb_dn *dn = NULL;
 
+	if (talloc_array_length(*answers) >= MAX_Q_RECURSION_DEPTH) {
+		return WERR_OK;
+	}
+
 	werror = dns_name2dn(dns, mem_ctx, question->name, &dn);
 	W_ERROR_NOT_OK_RETURN(werror);
 
